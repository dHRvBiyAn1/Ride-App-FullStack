<div class="ride-booking-container">
  <!-- Header -->
  <div class="booking-header">
    <button class="back-button" (click)="router.navigate(['/customer/dashboard'])">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5"/>
        <path d="M12 19l-7-7 7-7"/>
      </svg>
      Back to Dashboard
    </button>
    <h1 class="booking-title">Book a Ride</h1>
    <p class="booking-subtitle">Get a ride in minutes</p>
  </div>

  <!-- Progress Indicator -->
  <div class="progress-indicator">
    <div class="progress-steps">
      <div 
        class="progress-step"
        [class.active]="currentStep >= 1"
        [class.completed]="currentStep > 1"
        (click)="goToStep(1)">
        <div class="step-number">1</div>
        <div class="step-label">Location</div>
      </div>
      <div class="progress-line" [class.active]="currentStep > 1"></div>
      <div 
        class="progress-step"
        [class.active]="currentStep >= 2"
        [class.completed]="currentStep > 2"
        (click)="goToStep(2)">
        <div class="step-number">2</div>
        <div class="step-label">Ride Type</div>
      </div>
      <div class="progress-line" [class.active]="currentStep > 2"></div>
      <div 
        class="progress-step"
        [class.active]="currentStep >= 3"
        [class.completed]="currentStep > 3"
        (click)="goToStep(3)">
        <div class="step-number">3</div>
        <div class="step-label">Review</div>
      </div>
      <div class="progress-line" [class.active]="currentStep > 3"></div>
      <div 
        class="progress-step"
        [class.active]="currentStep >= 4"
        [class.completed]="currentStep > 4">
        <div class="step-number">4</div>
        <div class="step-label">Confirm</div>
      </div>
    </div>
  </div>

  <!-- Booking Form -->
  <div class="booking-content">
    <form [formGroup]="bookingForm" class="booking-form">
      
      <!-- Step 1: Location Selection -->
      <div class="step-content" *ngIf="currentStep === 1">
        <div class="step-header">
          <h2 class="step-title">Where would you like to go?</h2>
          <p class="step-description">Enter your pickup and destination locations</p>
        </div>

        <div class="location-inputs">
          <!-- Pickup Location -->
          <div class="form-group location-group">
            <label class="form-label">
              <div class="location-icon pickup-icon">
                <div class="location-dot"></div>
              </div>
              Pickup Location
            </label>
            <div class="input-container" [class.has-suggestions]="showPickupSuggestions">
              <input
                type="text"
                formControlName="pickupLocation"
                class="form-control location-input"
                placeholder="Enter pickup location"
                (input)="onPickupInput($event)"
                (focus)="onPickupInput($event)"
                (blur)="hidePickupSuggestions()"
                autocomplete="off">
              <button 
                type="button" 
                class="location-action-btn current-location-btn"
                (click)="getCurrentLocation()"
                title="Use current location">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="3,11 22,2 13,21 11,13 3,11"/>
                </svg>
              </button>
              
              <!-- Pickup Suggestions -->
              <div class="location-suggestions" *ngIf="showPickupSuggestions && filteredPickupSuggestions.length > 0">
                <div 
                  class="suggestion-item"
                  *ngFor="let suggestion of filteredPickupSuggestions"
                  (click)="selectPickupLocation(suggestion)">
                  <div class="suggestion-icon">üìç</div>
                  <div class="suggestion-content">
                    <div class="suggestion-name">{{ suggestion.name }}</div>
                    <div class="suggestion-address">{{ suggestion.address }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Swap Button -->
          <div class="swap-locations">
            <button type="button" class="swap-btn" (click)="swapLocations()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 11l4-4-4-4"/>
                <path d="M21 7H9"/>
                <path d="M7 13l-4 4 4 4"/>
                <path d="M3 17h12"/>
              </svg>
            </button>
          </div>

          <!-- Destination Location -->
          <div class="form-group location-group">
            <label class="form-label">
              <div class="location-icon destination-icon">
                <div class="location-dot"></div>
              </div>
              Destination
            </label>
            <div class="input-container" [class.has-suggestions]="showDestinationSuggestions">
              <input
                type="text"
                formControlName="destinationLocation"
                class="form-control location-input"
                placeholder="Where to?"
                (input)="onDestinationInput($event)"
                (focus)="onDestinationInput($event)"
                (blur)="hideDestinationSuggestions()"
                autocomplete="off">
              
              <!-- Destination Suggestions -->
              <div class="location-suggestions" *ngIf="showDestinationSuggestions && filteredDestinationSuggestions.length > 0">
                <div 
                  class="suggestion-item"
                  *ngFor="let suggestion of filteredDestinationSuggestions"
                  (click)="selectDestinationLocation(suggestion)">
                  <div class="suggestion-icon">üìç</div>
                  <div class="suggestion-content">
                    <div class="suggestion-name">{{ suggestion.name }}</div>
                    <div class="suggestion-address">{{ suggestion.address }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Popular Destinations -->
        <div class="popular-destinations">
          <h4 class="popular-title">Popular Destinations</h4>
          <div class="popular-grid">
            <button 
              type="button"
              class="popular-item"
              *ngFor="let location of locationSuggestions.slice(0, 6)"
              (click)="selectDestinationLocation(location)">
              <div class="popular-icon">{{ location.name.includes('Airport') ? '‚úàÔ∏è' : 'üìç' }}</div>
              <div class="popular-name">{{ location.name }}</div>
            </button>
          </div>
        </div>

        <div class="step-actions">
          <button 
            type="button" 
            class="btn btn-primary btn-lg btn-full"
            [disabled]="!validateStep1() || isLoadingFare"
            (click)="nextStep()">
            <app-loading *ngIf="isLoadingFare" size="sm" color="white"></app-loading>
            <span *ngIf="!isLoadingFare">Continue</span>
          </button>
        </div>
      </div>

      <!-- Step 2: Ride Type Selection -->
      <div class="step-content" *ngIf="currentStep === 2">
        <div class="step-header">
          <h2 class="step-title">Choose your ride</h2>
          <p class="step-description">Select the type of ride that suits your needs</p>
        </div>

        <div class="ride-types">
          <div 
            class="ride-type-card"
            *ngFor="let rideType of rideTypes"
            [class.selected]="selectedRideType === rideType"
            (click)="selectRideType(rideType)">
            <div class="ride-type-icon">{{ getRideTypeIcon(rideType) }}</div>
            <div class="ride-type-info">
              <div class="ride-type-name">{{ rideTypeConfig[rideType].name || rideType }}</div>
              <div class="ride-type-description">{{ getRideTypeDescription(rideType) }}</div>
              <div class="ride-type-features">
                <span class="feature-item" *ngIf="rideType === 'ECONOMY'">üí∞ Affordable</span>
                <span class="feature-item" *ngIf="rideType === 'PREMIUM'">‚≠ê Comfortable</span>
                <span class="feature-item" *ngIf="rideType === 'LUXURY'">üëë Premium</span>
              </div>
            </div>
            <div class="ride-type-pricing" *ngIf="fareEstimate">
              <div class="estimated-fare">{{ formatCurrency(fareEstimate.estimatedFare) }}</div>
              <div class="estimated-time">{{ formatDuration(fareEstimate.estimatedDuration) }}</div>
            </div>
            <div class="selection-indicator">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn btn-secondary" (click)="previousStep()">
            Back
          </button>
          <button 
            type="button" 
            class="btn btn-primary btn-lg"
            [disabled]="!validateStep2()"
            (click)="nextStep()">
            Continue
          </button>
        </div>
      </div>

      <!-- Step 3: Review & Options -->
      <div class="step-content" *ngIf="currentStep === 3">
        <div class="step-header">
          <h2 class="step-title">Review your ride</h2>
          <p class="step-description">Check the details before booking</p>
        </div>

        <div class="ride-summary">
          <!-- Route Summary -->
          <div class="summary-card route-summary">
            <h4 class="summary-title">Route</h4>
            <div class="route-details">
              <div class="route-point">
                <div class="route-icon pickup-icon">
                  <div class="location-dot"></div>
                </div>
                <div class="route-info">
                  <div class="route-label">Pickup</div>
                  <div class="route-address">{{ bookingForm.get('pickupLocation')?.value }}</div>
                </div>
              </div>
              <div class="route-line"></div>
              <div class="route-point">
                <div class="route-icon destination-icon">
                  <div class="location-dot"></div>
                </div>
                <div class="route-info">
                  <div class="route-label">Destination</div>
                  <div class="route-address">{{ bookingForm.get('destinationLocation')?.value }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ride Details -->
          <div class="summary-card ride-details">
            <h4 class="summary-title">Ride Details</h4>
            <div class="detail-item">
              <div class="detail-label">Ride Type</div>
              <div class="detail-value">
                <span class="ride-icon">{{ getRideTypeIcon(selectedRideType) }}</span>
                {{ rideTypeConfig[selectedRideType].name || selectedRideType }}
              </div>
            </div>
            <div class="detail-item" *ngIf="fareEstimate">
              <div class="detail-label">Distance</div>
              <div class="detail-value">{{ fareEstimate.distance.toFixed(1) }} miles</div>
            </div>
            <div class="detail-item" *ngIf="fareEstimate">
              <div class="detail-label">Estimated Time</div>
              <div class="detail-value">{{ formatDuration(fareEstimate.estimatedDuration) }}</div>
            </div>
          </div>

          <!-- Fare Breakdown -->
          <div class="summary-card fare-breakdown" *ngIf="fareEstimate">
            <h4 class="summary-title">Fare Breakdown</h4>
            <div class="fare-item">
              <div class="fare-label">Base Fare</div>
              <div class="fare-value">{{ formatCurrency(fareEstimate.baseFare) }}</div>
            </div>
            <div class="fare-item">
              <div class="fare-label">Distance ({{ fareEstimate.distance.toFixed(1) }} miles)</div>
              <div class="fare-value">{{ formatCurrency((fareEstimate.distance || 0) * fareEstimate.pricePerMile) }}</div>
            </div>
            <div class="fare-divider"></div>
            <div class="fare-item fare-total">
              <div class="fare-label">Total Fare</div>
              <div class="fare-value">{{ formatCurrency(fareEstimate.estimatedFare) }}</div>
            </div>
          </div>
        </div>

        <!-- Additional Options -->
        <div class="additional-options">
          <div class="form-group">
            <label class="form-label">Schedule for later (Optional)</label>
            <input
              type="datetime-local"
              formControlName="scheduledTime"
              class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">Special Instructions (Optional)</label>
            <textarea
              formControlName="specialInstructions"
              class="form-control"
              rows="3"
              placeholder="Any special instructions for your driver..."></textarea>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn btn-secondary" (click)="previousStep()">
            Back
          </button>
          <button 
            type="button" 
            class="btn btn-primary btn-lg"
            (click)="nextStep()">
            Continue to Booking
          </button>
        </div>
      </div>

      <!-- Step 4: Final Confirmation -->
      <div class="step-content" *ngIf="currentStep === 4">
        <div class="step-header">
          <h2 class="step-title">Confirm your booking</h2>
          <p class="step-description">Your ride will be confirmed in seconds</p>
        </div>

        <div class="booking-confirmation">
          <div class="confirmation-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.293-.707L19 9.414a1 1 0 0 0-.707-.293H15.5L14 7H9L7.5 9.121H5.207a1 1 0 0 0-.707.293L2 12.121V16h3"/>
              <circle cx="6.5" cy="16" r="2.5"/>
              <circle cx="16.5" cy="16" r="2.5"/>
            </svg>
          </div>
          
          <div class="confirmation-details">
            <h3 class="confirmation-title">Ready to book?</h3>
            <p class="confirmation-description">
              We'll find you a nearby {{ rideTypeConfig[selectedRideType].name }} driver and send you their details.
            </p>
            
            <div class="final-summary">
              <div class="summary-row">
                <span>From:</span>
                <span>{{ bookingForm.get('pickupLocation')?.value }}</span>
              </div>
              <div class="summary-row">
                <span>To:</span>
                <span>{{ bookingForm.get('destinationLocation')?.value }}</span>
              </div>
              <div class="summary-row">
                <span>Ride Type:</span>
                <span>{{ rideTypeConfig[selectedRideType].name }}</span>
              </div>
              <div class="summary-row total-row" *ngIf="fareEstimate">
                <span>Total Fare:</span>
                <span class="total-fare">{{ formatCurrency(fareEstimate.estimatedFare) }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn btn-secondary" (click)="previousStep()">
            Back
          </button>
          <button 
            type="button" 
            class="btn btn-primary btn-lg btn-full confirm-btn"
            [disabled]="isBookingRide"
            (click)="confirmBooking()">
            <app-loading *ngIf="isBookingRide" size="sm" color="white"></app-loading>
            <span *ngIf="!isBookingRide">Confirm Booking</span>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Reset Form Button -->
  <div class="booking-footer">
    <button type="button" class="btn btn-outline btn-sm" (click)="resetForm()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
        <path d="M21 3v5h-5"/>
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
        <path d="M8 16l-5-5 5-5"/>
      </svg>
      Start Over
    </button>
  </div>
</div>
